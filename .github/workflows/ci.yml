name: Int√©gration Continue

on:
  push:
    branches: 
      - main
  pull_request:
    branches:
      - main

jobs:
  test:
    runs-on: ubuntu-latest
    services:
      zookeeper:
        image: wurstmeister/zookeeper:3.4.6
        ports:
          - 2181:2181
      kafka:
        image: wurstmeister/kafka:2.13-2.7.0
        ports:
          - 9092:9092
        env:
          KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://localhost:9092
          KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
        options: --health-cmd="echo ruok | nc -w 1 localhost 2181 | grep imok" --health-interval=10s --health-timeout=5s --health-retries=5
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up JDK 11
        uses: actions/setup-java@v3
        with:
          java-version: 11

      - name: Build and test ms-orders
        working-directory: ms-orders
        run: |
          ./mvnw clean install
          ./mvnw test

      - name: Build and test ms-stock
        working-directory: ms-stock
        run: |
          ./mvnw clean install
          ./mvnw test

      - name: Build and test ms-payments
        working-directory: ms-payments
        run: |
          ./mvnw clean install
          ./mvnw test
